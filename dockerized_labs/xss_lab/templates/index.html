{% extends 'base.html' %}

{% block title %}
<title>Cross-Site Scripting (XSS) Lab</title>
{% endblock %}

{% block content %}
<div class="content">
    <div class="header-container">
        <h1 style="border-bottom: 2px solid #474646; padding-bottom: 10px;">Cross-Site Scripting (XSS) Lab</h1>
        <button class="notebook-btn" onclick="openModal()" title="View Secure Implementation">
        ðŸ”—
        </button>
    </div>
    {% include 'secure-fix.html' %}
    <div class="box">
        <h4>What is Cross-Site Scripting (XSS)?</h4>
        <p class="bp">
            Cross-site scripting (XSS) is a form of client-side code injection where the attacker tries to inject malicious script into a trusted site. The malicious script is usually a piece of JavaScript code, which helps the attacker to perform malicious activities, like redirecting the victim to an attacker site, stealing cookies etc. Sometimes XSS vulnerability can be chained with other vulnerabilities to create greater impact.

            There are three main types of XSS attacks:
        </p>

        <h4>Types of XSS</h4>
        <div class="section">
            <h5>1. Reflected XSS</h5>
            <p class="bp">
                Reflected XSS occurs when user input is immediately returned by a web application in an error
                message, search result, or any other response that includes some or all of the input provided by the user as
                part of the request, without that data being made safe to render in the browser.
            </p>

            <h5>2. Stored XSS</h5>
            <p class="bp">
                Stored XSS occurs when user input is stored on the target server, such as in a database, in a message forum, visitor log, 
                comment field, etc. And then a victim is able to retrieve the stored data from the web application without that data being made 
                safe to render in the browser.
            </p>

            <h5>3. DOM XSS</h5>
            <p class="bp">
                DOM-based XSS occurs when JavaScript takes an attacker-controllable value and passes it to a sink that supports dynamic code execution. 
                The vulnerability exists in client-side code rather than server-side code.
            </p>
        </div>

        <div class="lab">
            <p class="bp">
                This lab contains three different XSS challenges that demonstrate each type of XSS vulnerability.
            </p>
            <p class="bp">
                The labs demonstrate:
                <ul>
                    <li>Reflected XSS through unescaped search results</li>
                    <li>Stored XSS with simple filter bypass</li>
                    <li>DOM XSS using non-alphanumeric JavaScript</li>
                </ul>
            </p>
            <div style="text-align: right;">
                <button type="button" onclick="showLabDetails()" style="margin-right: 10px;">Lab Details</button>
                <button type="button" onclick="window.location.href='/lab1'" style="margin-right: 10px;">Lab 1</button>
                <button type="button" onclick="window.location.href='/lab2'" style="margin-right: 10px;">Lab 2</button>
                <button type="button" onclick="window.location.href='/lab3'">Lab 3</button>
            </div>
        </div>

        <div id="labDetails" class="section" style="display: none; margin-top: 20px;">
            <h4>Lab Descriptions</h4>
            
            <div class="lesson-section">
                <h5>Lab 1: Reflected XSS</h5>
                <p class="bp">
                    Search for FAANG companies and try:
                    <ul>
                        <li>Enter a regular company name</li>
                        <li>Try using HTML tags in the search</li>
                        <li>Attempt to execute JavaScript through script tags</li>
                    </ul>
                </p>
            </div>

            <div class="lesson-section">
                <h5>Lab 2: Stored XSS with Filter</h5>
                <p class="bp">
                    The comment system tries to block XSS:
                    <ul>
                        <li>Simple filter removes script tags</li>
                        <li>Try alternative HTML tags</li>
                        <li>Goal: Set the flag cookie to "success"</li>
                    </ul>
                </p>
            </div>

            <div class="lesson-section">
                <h5>Lab 3: DOM XSS Challenge</h5>
                <p class="bp">
                    Bypass alphanumeric filtering:
                    <ul>
                        <li>All letters and numbers are removed</li>
                        <li>Output is placed in a script tag</li>
                        <li>Use special characters to construct code</li>
                    </ul>
                </p>
            </div>
        </div>
        <div class="section">
            <h4>Mitigation</h4>
            <p class="bp"> First let's analyse what part of the code has resulted in this vulnerability.


                <br><b>#code in views.py</b><br></bt>
                <code>return render(request,'Lab/XSS/xss_lab.html',{'query': q})</code><br>
                <br><b>#code in html template</b><br>
                <code> &lt;h3&gt; The company '{query|safe}' You searched for is not Part of FAANG &lt;/h3&gt;</code>
            </p>

            <p class="bp">In the above code the q variable holds the users input . This input is stored in a variable called
                <b>â€˜queryâ€™</b> , which is sent to a html template which renders a html along with the value of the query.
            </p>
            <p class="bp">The query received from the user is considered to be safe which resulted in the template rendering
                the user input without escaping the input. This can be seen by using the keyword <b>'safe'</b> in the html
                template.</p>

            <br>
            <p class="bp">
            <h4>What happens without the safe keyword?</h4><br>


            <p class="bp">Without the safe keyword Django would automatically escape the malicious string in the query
                context variable.</p>

            <p class="bp">It does this by passing all string data through Pythonâ€™s <code>html.escape()</code> function. This
                function will:</p>
            <ul class="bp">
                <li>Replace any & with an <code>& amp;</code> ampersand HTML character-reference</li>
                <li>Replace any < or> with an & lt; or & gt; HTML character-reference</li>
                <li>Replace any " with an escaped \"</li>
                <li>Replace any ' with an escaped \'</li>


            </ul>

            </p>
            

                <br>
            <h4>Now talking about the mitigation</h4>

            <br>
            <p class="bp">
                <li>Encode the following characters with HTML entity encoding to prevent switching into any execution
                    context, such as script, style, or event handlers. Using hex entities is recommended in the spec. The 5
                    characters significant in XML.

                    <ul>
                        <code>& --> & amp;</code><br>
                        <code>
                            < --> & lt;
                        </code><br>
                        <code> --> & gt;</code><br>
                        <code>" --> & quot;</code><br>
                        <code>' --> &# x27;</code>
                    </ul>
                </li>

                <li>CSS Encode And Strictly Validate Before Inserting Untrusted Data into HTML Style Property Values</li>
                <li>JavaScript Encode Before Inserting Untrusted Data into JavaScript Data Values</li>


                <li>HTML Encode JSON values in an HTML context and read the data with JSON.parse</li>

                <li>URL Encode Before Inserting Untrusted Data into HTML URL Parameter Values</li>
                <li>Implement Content Security Policy</li>
                <li>Use HTTPOnly cookie flag</li>


            

            </p>
        </div>


    </div>
</div>

<script>
function showLabDetails() {
    const details = document.getElementById('labDetails');
    if (details.style.display === 'none') {
        details.style.display = 'block';
    } else {
        details.style.display = 'none';
    }
}

// Modal functionality
function openModal() {
    document.getElementById('secureFixModal').style.display = 'block';
    document.body.style.overflow = 'hidden'; 
}

function closeModal() {
    document.getElementById('secureFixModal').style.display = 'none';
    document.body.style.overflow = 'auto'; 
}
function showTab(tabName) {
    const panels = document.querySelectorAll('.tab-panel');
    panels.forEach(panel => panel.classList.remove('active'));
    
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(tabName).classList.add('active');
    
    event.target.classList.add('active');
}

document.addEventListener('click', function(event) {
    const modal = document.getElementById('secureFixModal');
    const overlay = event.target.classList.contains('modal-overlay');
    if (overlay) {
        closeModal();
    }
});

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}
