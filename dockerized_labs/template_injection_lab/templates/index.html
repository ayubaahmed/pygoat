{% extends "base.html" %}

{% block title %}<title>Server-side Template Injection</title>{% endblock %}

{% block content %}
<div class="content">
    <div class="header-container">
        <h1 style="border-bottom: 2px solid #474646; padding-bottom: 10px;">Server-side Template Injection</h1>
        <button class="notebook-btn" onclick="openModal()" title="View Secure Implementation">
        ðŸ”—
        </button>
    </div>
    {% include 'secure-fix.html' %}
    <div class="section">
        <h4>What is Template Injection?</h4>
        <p class="bp">
            A Template is a reusable and dynamic HTML code that a template engine compiles. Template engines provide flexibility and 
            allow us to use variables and logic in HTML code. However, when user input is directly embedded into templates without 
            proper validation, it can lead to server-side template injection vulnerabilities.
        </p>

        <div class="info">
            <h4>Vulnerabilities occur when:</h4>
            <ul>
                <li>User-supplied data is not validated, filtered, or sanitized by the application and directly embedded into a server side template</li>
                <li>Using malicious template directives, an attacker may be able to execute arbitrary code and take full control of the web server.</li>
                <li>Hostile data is used within object-relational mapping (ORM) search parameters to extract additional, sensitive records.</li>
            </ul>
        </div>
    </div>

    <div class="lab">
        <button class="coll btn btn-info" onclick="toggleLabDetails('lab')">Lab Details</button>
        <div id="lab" class="section" style="display: none;">
            <h4>Blog System with Template Injection</h4>
            <p class="bp">
                This lab simulates a blog system that uses Jinja2 template engine but doesn't properly validate user input.
                Your goal is to exploit the template injection vulnerability to access sensitive information.
            </p>
            
            <div class="info">
                <h4>Challenge:</h4>
                <ul>
                    <li>Create a blog post that exploits template injection</li>
                    <li>Try to access server information using template expressions</li>
                    <li>Find ways to execute arbitrary Python code through template syntax</li>
                </ul>
            </div>

            <div class="button-container">
                <button onclick="window.location.href='/lab'">Access Lab</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h4>Mitigation</h4>
        <ul>
            <li>Validate and sanitize all user input before processing</li>
            <li>Use safe template syntax and disable dangerous features</li>
            <li>Implement proper template sandboxing</li>
            <li>Follow the principle of least privilege</li>
        </ul>
    </div>
</div>

<script>
function toggleLabDetails(id) {
    const el = document.getElementById(id);
    if (el.style.display === "none" || el.style.display === "") {
        el.style.display = "block";
    } else {
        el.style.display = "none";
    }
}

    // Modal functionality
function openModal() {
    document.getElementById('secureFixModal').style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeModal() {
    document.getElementById('secureFixModal').style.display = 'none';
    document.body.style.overflow = 'auto'; // Re-enable background scrolling
}

// Tab functionality
function showTab(tabName) {
    // Hide all tab panels
    const panels = document.querySelectorAll('.tab-panel');
    panels.forEach(panel => panel.classList.remove('active'));
    
    // Remove active class from all tab buttons
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab panel
    document.getElementById(tabName).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

// Close modal when clicking overlay
document.addEventListener('click', function(event) {
    const modal = document.getElementById('secureFixModal');
    const overlay = event.target.classList.contains('modal-overlay');
    if (overlay) {
        closeModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}
