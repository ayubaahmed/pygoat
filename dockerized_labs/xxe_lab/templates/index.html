{% extends 'base.html' %}

{% block title %}XXE Injection Lab{% endblock %}

{% block content %}
<div class="content">
    <div class="header-container">
        <h1 style="border-bottom: 2px solid #474646; padding-bottom: 10px;">XXE Injection Lab</h1>
        <button class="notebook-btn" onclick="openModal()" title="View Secure Implementation">
        ðŸ”—
        </button>
    </div>
    
    <!-- Include the secure fix modal -->
    {% include 'secure-fix.html' %}
    <div class="box">
        <h3>What is XML External Entity Injection</h3>
        <p class="bp">
            XML External Entity injection (also known as XXE) is a web security vulnerability that allows an
            attacker to interfere with an application's processing of XML data. It is a type of attack against an
            application that parses XML input. This attack occurs when XML input containing a reference to an external
            entity is processed by a weakly configured XML parser.
            <br><br>
            It often allows an attacker to view files on the application server filesystem, and to interact with any
            back-end or external systems that the application itself can access.
            <br><br>
            In some situations, an attacker can escalate an XXE attack to compromise the underlying server or other
            back-end infrastructure, by leveraging the XXE vulnerability to perform server-side request forgery (SSRF)
            attacks.
        </p>
    </div>
        <button class="coll btn btn-info" onclick="toggleLabDetails()">Lab Details</button>
        <div id="labDetails" class="lab" style="display: none;">
            <p class="bp">
                This lab helps us to understand how XXE vulnerabilities can be exploited in the wild.
                The lab consists of a commenting feature which asks the user to enter his/her thoughts about a picture
                shown! Once comments are entered, they can be viewed using the provided feature.
            </p>

            <p class="bp">
                <b>What could go wrong here?</b><br>
                When the user clicks the button to save comments, the data is sent to the server in the form of XML
                post request. This can be seen by intercepting the request using 
                <b><a href="https://portswigger.net/burp/communitydownload">BurpSuite</a></b>.
                <br><br>
                Sending data to the server in the form of XML is not actually vulnerable, the vulnerability lies in the
                way the <i>XML is being parsed</i>. An XML parser which allows DTD retrieval is vulnerable to XXE 
                injection if there aren't any input validations done on the XML data.
            </p>

            <p class="bp">
                <b>Exploiting the XML Parser</b>
            <ul>
                <li>Open Burpsuite and make sure it is ready to capture the web traffic.</li>
                <li>Enter your comments in the input box provided.</li>
                <li>Before hitting the <b>Let the world see</b> button go to burpsuite and turn on intercept.</li>
                <li>Now you should be able to see a post request containing XML data with your comment inside the text tag.</li>
                <li>Now we need to introduce a DTD, which tries to fetch files from the server.</li>
                <li>This can be done by using the document tag and defining the Entity.</li>
                <li>The Payload:</li>
                <br>
                <code class="code-block">
                    &lt;?xml version='1.0'?><br>
                    &lt;!DOCTYPE comm [<br>
                    &lt;!ELEMENT comm (#PCDATA)><br>
                    &lt;!ENTITY xxe SYSTEM "File_Path_Here"><br>
                    ]><br>
                    &lt;comm><br>
                    &lt;text>&xxe;&lt;/text><br>
                    &lt;/comm>
                </code>
                <br>
                <li>For Linux systems, use file path <code>file:///etc/passwd</code></li>
                <li>For Windows systems, use <code>C:\windows\system32\drivers\etc\hosts</code></li>
                <li>Forward the request and turn off intercept.</li>
                <li>Click "View Comments" to see if the requested files are displayed.</li>
            </ul>
            </p>

            <div align="right">
                <button class="btn btn-info" type="button" onclick="window.location.href='/lab'">Access Lab</button>
            </div>
        </div>

        <div class="box">
            <h2>Mitigation</h2>
            <ul>
                <li>DTD and XML external entity features must be disabled.</li>
                <li>All XML processors and libraries used in the application must be patched and updated always.</li>
                <li>Ensure that user inputs are validated before being parsed.</li>
                <li>Make use of secure XML parsers that aren't vulnerable by default.</li>
            </ul>
        </div>
</div>

<script>
function toggleLabDetails() {
    const details = document.getElementById('labDetails');
    if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'block';
    } else {
        details.style.display = 'none';
    }
}

// Modal functionality
function openModal() {
    document.getElementById('secureFixModal').style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeModal() {
    document.getElementById('secureFixModal').style.display = 'none';
    document.body.style.overflow = 'auto'; // Re-enable background scrolling
}

// Tab functionality
function showTab(tabName) {
    // Hide all tab panels
    const panels = document.querySelectorAll('.tab-panel');
    panels.forEach(panel => panel.classList.remove('active'));
    
    // Remove active class from all tab buttons
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab panel
    document.getElementById(tabName).classList.add('active');
    
    // Add active class to clicked button
    event.target.classList.add('active');
}

// Close modal when clicking overlay
document.addEventListener('click', function(event) {
    const modal = document.getElementById('secureFixModal');
    const overlay = event.target.classList.contains('modal-overlay');
    if (overlay) {
        closeModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}
